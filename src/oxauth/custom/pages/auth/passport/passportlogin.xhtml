<!DOCTYPE composition
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:b="http://bootsfaces.net/ui" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:x-data="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:x-init="http://xmlns.jcp.org/jsf/passthrough" xmlns:x-on="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:x-for="http://xmlns.jcp.org/jsf/passthrough" xmlns:x-bind="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:x-if="http://xmlns.jcp.org/jsf/passthrough" xmlns:x-text="http://xmlns.jcp.org/jsf/passthrough"
	template="/WEB-INF/incl/layout/login-extended-template.xhtml">

	<f:metadata>
		<f:viewAction action="#{authenticator.prepareAuthenticationForStep}" if="#{not identity.loggedIn}" />
	</f:metadata>

	<ui:define name="head">
		<meta name="description" content="Gluu Inc." />
		<style type="text/css">
			body {
				padding: 0;
			}

			.navbar-nav {
				padding-top: 30px;
			}

			ul,
			ol {
				margin-bottom: 0;
			}

			a {
				color: #2300cc;
				transition: all 0.5s ease-in-out 0s;
			}

			a:hover,
			a:focus {
				color: #079857;
				text-decoration: none;
				transition: all 0.5s ease-in-out 0s;
			}

			.btn-login {
				color: #fff;
				background-color: #00BE79;
				border-color: #ffffff;
				min-width: 100px;
				transition: all 0.5s ease-in-out 0s;
			}

			.btn-login:hover,
			.btn-login:focus {
				background-color: #00BE79;
				border-color: #079857;
				color: #079857;
				transition: all 0.5s ease-in-out 0s;
			}

			.form-control:focus {
				border-color: #007541;
			}

			input[type="text"]:focus,
			input[type="password"]:focus {
				box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(0, 117, 65, 0.71), inset 0px 0px 3px #007541;
			}

			.panel-default>.panel-heading {
				color: #079857;
				font-size: 18px;
			}

			.input-name {
				padding-top: 3px;
			}

			.panel-order hr {
				margin: 10px 15px;
			}

			.panel-order .panel-body {
				height: 260px;
				overflow-y: auto;
			}

			.panel-order .panel-body>.row:last-child hr {
				display: none;
			}

			.list-inline>li {
				margin-bottom: 5px;
				vertical-align: middle;
			}

			.list-inline>li img {
				max-width: 40px;
			}

			.social-wrapper {
				position: relative;
				text-align: center;
				padding: 20px;
				border: 1px solid #dfdfdf;
				border-radius: 4px;
				background-color: #f5f5f5;
			}

			#footer {
				padding: 30px 0 20px;
				text-align: center;
				border-top: 0;
			}

			/* Media Query */
			@media (max-width : 979px) {
				.navbar .container {
					padding: 0 15px;
				}
			}

			@media (max-width : 767px) {
				.navbar {
					text-align: center;
				}

				.navbar-nav {
					padding-top: 0px;
				}

				.navbar-header img {
					max-width: 130px;
				}

				#content.sign-in-page {
					padding-top: 30px;
				}

				.list-inline>li img {
					max-width: 30px;
				}
			}

			.panel-success>.panel-heading {
				color: white !important;
				background-color: #00BE79 !important;
				border-color: #d6e9c6;
			}
		</style>
	</ui:define>

	<ui:define name="pageTitle">
		<h:outputText value="#{msgs['passport.oxAuthPassportLogin']}" />
	</ui:define>

	<ui:define name="body">
		<section x-data="loginFormComponent()" x-init="mounted" class="container mt-5">
			<div class="row">
				<div class="col-sm-6 col-12 text-center">
					<div class="">
						<h3>ចូលគណនី</h3>
						<div class="py-2"></div>
						<h:form id="loginForm" x-on:submit="onFormSubmit" class="text-left">
							<h:inputHidden x-model="form.provider" id="provider" />

							<h:messages class="text-danger"></h:messages>

							<div class="form-group row">
								<label for="username" class="col-sm-3 col-form-label">ឈ្មោះអ្នកប្រើ</label>
								<div class="col-sm-9">
									<h:inputText x-model="form.username" id="username" value="#{credentials.username}"
										autocomplete="off" class="form-control usernameField" />
								</div>
							</div>
							<div class="form-group row">
								<label for="password" class="col-sm-3 col-form-label">ពាក្យសម្ងាត់</label>
								<div class="col-sm-9">
									<h:inputSecret x-model="form.password" id="password" value="#{credentials.password}"
										autocomplete="off" class="form-control passwordField" />
								</div>
							</div>

							<div class="form-group row">
								<div class="offset-sm-3 col-sm-9 text-left">
									<div class="form-check">
										<input x-model="form.remember" type="checkbox" value="rememberme"
											id="rememberme" class="form-check-input rememberField" />
										<label class="form-check-label" for="rememberme">
											ចងចាំឈ្មោះអ្នកប្រើ
										</label>
									</div>
								</div>
							</div>

							<div class="row">
								<div class="offset-3 col-9 text-left">
									<h:commandButton id="loginButton" value="#{msgs['login.login']}"
										action="#{authenticator.authenticate}"
										class="btn btn-moeys-primary btn-lg w-50 text-left" />
								</div>
							</div>
							<!-- </form> -->
						</h:form>
					</div>
					<div class="col-12">
						<div class="d-block py-4"></div>
						<a class="h5 text-moeys-primary" x-bind:href="links.forgetPassword">
							ភ្លេចពាក្យសម្ងាត់ ឬឈ្មោះអ្នកប្រើរបស់អ្នកឬ ?
						</a>

						<div class="d-block py-2"></div>
						<div>
							<h6 class="d-inline-block">ត្រូវតែបើកខូគី នៅក្នុងកម្មវិធីរុករករបស់អ្នក</h6>
							<span class="d-inline-block align-top">
								<a x-bind:href="links.enableCookie" target="_blank">
									<img class="icon iconhelp"
										alt="ជំនួយអំពី ត្រូវតែបើកខូគី នៅក្នុងកម្មវិធីរុករករបស់អ្នក"
										title="ជំនួយអំពី ត្រូវតែបើកខូគី នៅក្នុងកម្មវិធីរុករករបស់អ្នក"
										src="https://elearning.moeys.gov.kh/theme/image.php/adaptable/core/1582273361/help"
										id="yui_3_17_2_1_1583894054733_47" />
								</a>
							</span>
						</div>
					</div>
				</div>
				<div class="col-sm-6 col-12 text-center">
					<div class="">
						<h3>តើអ្នកមកទីនេះជាលើកដំបូងឬ ?</h3>
						<div class="py-2"></div>
						<p class="w-75 mx-auto">
							ដើម្បីអាចចូលដំណើរការវគ្គសិក្សាបានពេញលេញបាន
							អ្នកត្រូវចំណាយពេលបន្តិច ដើម្បីបង្កើតគណនីថ្មីសម្រាប់ខ្លួនអ្នក
							នៅលើតំបន់បណ្ដាញនេះ។
						</p>

						<a class="btn btn-moeys-primary btn-lg" x-bind:href="links.register">បង្កើតគណនីថ្មី</a>
					</div>

					<div class="mt-5">
						<h5 class="font-weight-bold">ចូលដោយប្រើគណនីរបស់អ្នកនៅ</h5>
						<div class="py-2"></div>

						<div class="">
							<template x-for="provider in providers" :key="provider.name">
								<a x-on:click="onProviderLogin(provider.name)"
									class="d-block text-primary text-decoration-none py-2" href="#">
									<span class="d-inline-block mr-2">
										<img x-bind:src="provider.data.logo_img" x-bind:alt="provider.name" class=""
											width="28px" />
									</span>
									<span x-text="provider.data.displayName"
										class="d-inline-block align-middle h5 m-0"></span>
								</a>
							</template>
						</div>
					</div>
				</div>
			</div>
		</section>

		<script type="text/javascript">
			//<![CDATA[

			function loginFormComponent() {
				const localStorageKeys = {
					username: "form-username",
					password: "form-password"
				};

				return {
					providers: [],

					links: {
						register: "/identity/register.htm",
						forgetPassword: "/identity/person/passwordReminder.htm",
						enableCookie: "https://elearning.moeys.gov.kh/help.php?component=moodle&identifier=cookiesenabled&lang=km"
					},

					form: {
						provider: "",
						username: "#{credentials.username}",
						password: "#{credentials.password}",
						remember: false
					},

					mounted() {
						this.getGluuProviders();

						setTimeout(() => this.fillCredentials(), 400);
					},
					fillCredentials() {
						const username = localStorage.getItem(localStorageKeys.username);
						const password = localStorage.getItem(localStorageKeys.password);

						if (!username || !password) return;

						this.form.username = username;
						this.form.password = password;
						this.form.remember = true;
					},
					saveCredentials(username, password) {
						localStorage.setItem(localStorageKeys.username, username);
						localStorage.setItem(localStorageKeys.password, password);
					},
					clearCredentials() {
						localStorage.removeItem(localStorageKeys.username);
						localStorage.removeItem(localStorageKeys.password);
					},
					onFormSubmit(event) {
						event.preventDefault();

						if (this.form.remember) {
							this.saveCredentials(this.form.username, this.form.password);
						} else {
							this.clearCredentials();
						}

						console.log("onFormSubmit", event);

						// Trigger form submit action
						event.target.submit();
					},
					onProviderLogin(provider) {
						console.log("onProviderLogin", provider);
					},
					getGluuProviders() {
						const providerdat = JSON.parse('${identity.getWorkingParameter('externalProviders')}');

						for (var prvid in providerdat) {
							this.providers.push({
								name: prvid,
								data: providerdat[prvid]
							});
						}
					}
				};
			}

			// Start AlpineJS Service
			jQuery(document).ready(function () {
				Alpine.start();
			});

			//]]>
		</script>
	</ui:define>
</ui:composition>
